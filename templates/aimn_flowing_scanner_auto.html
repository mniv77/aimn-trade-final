<!-- templates/aimn_flowing_scanner_auto.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIMn Flowing Scanner Dashboard - AUTO MODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes scroll { 0% { transform: translateX(100%);} 100% { transform: translateX(-100%);} }
    @keyframes scroll-reverse { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }
    .animate-scroll { animation: scroll 80s linear infinite; }
    .animate-scroll-reverse { animation: scroll-reverse 60s linear infinite; }

    @keyframes scanPulse { 0%,100%{ box-shadow:0 0 0 0 rgba(59,130,246,.7); transform:scale(1);} 50%{ box-shadow:0 0 0 10px rgba(59,130,246,0); transform:scale(1.02);} }
    @keyframes scannerBeam { 0% { left: -100%; } 100% { left: 100%; } }

    .row-testing{ animation:scanPulse 2s infinite; border:2px solid #3b82f6!important; position:relative; overflow:hidden; background:linear-gradient(90deg,rgba(59,130,246,.15),rgba(59,130,246,.25),rgba(59,130,246,.15)); }
    .row-testing::before{ content:''; position:absolute; inset:0 auto 0 -100%; width:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent); animation:scannerBeam 2s infinite; }
    .row-testing::after{ content:'AUTO-TRADING...'; position:absolute; top:2px; right:2px; background:#3b82f6; color:#fff; padding:2px 6px; border-radius:3px; font-size:10px; font-weight:700; }

    .broker-available { background: rgba(0,128,0,0.15); border-color:#10b981; }
    .broker-busy { background: rgba(255,140,0,0.15); border-color:#f59e0b; }
    .broker-out-of-hours { background: rgba(251,191,36,0.2); border-color:#fbbf24; }  /* BRIGHT YELLOW for out of hours */

    /* NEW: Filter-based coloring */
    .symbol-filter-passed { background: rgba(0,200,0,0.12); border-left:4px solid #10b981; }  /* GREEN - Passed filters */
    .symbol-filter-failed { background: rgba(234,179,8,0.08); border-left:4px solid #ca8a04; }  /* YELLOW/GOLD - Failed filters */
    .symbol-busy-active { background: rgba(220,38,38,0.18); border-left:4px solid #dc2626; }  /* RED - Active trade */
    .symbol-busy-blocked { background: rgba(120,53,15,0.18); border-left:4px solid #92400e; }  /* BROWN - Blocked */

    .ticker-available { background:#065f46; border:1px solid #10b981; color:#d1fae5; }
    .ticker-filter-warning { background:#065f46; border:1px solid #10b981; color:#d1fae5; }  /* Same as available, will add yellow dot */
    .ticker-out-of-hours { background:#065f46; border:1px solid #10b981; color:#d1fae5; }  /* Same as available, will add yellow dot */
    .ticker-active-trade { background:#991b1b; border:1px solid #ef4444; color:#fecaca; }  /* BRIGHT RED */
    .ticker-blocked { background:#451a03; border:1px solid #78350f; color:#fcd34d; opacity:.85; }  /* BROWN for blocked */
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div class="p-4 mb-4">
    <h1 class="text-3xl font-bold text-center mb-2">ü§ñ AIMn Auto-Trading Scanner (Smart Filters)</h1>
    <p class="text-center text-gray-400">Fully Automated Multi-Exchange Market Scanning & Trading</p>
    <p class="text-center text-xs text-green-400 mt-1">‚ö° AUTO MODE - Multi-Filter: RSI + ATR + Volume + Recency</p>

    <div class="text-center mt-4">
      <div class="flex justify-center gap-4">
        <button onclick="openTradePopupTestStock()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
          üìä Manual Test - Stock (AAPL)
        </button>
        <button onclick="openTradePopupTestCrypto()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
          ‚Çø Manual Test - Crypto (BTC)
        </button>
      </div>
      <p class="text-gray-500 text-sm mt-2">
        üü¢ Green = Ready to trade | üü° Yellow = Needs improvement or closed | üî¥ Red = Trading | üü§ Brown = Blocked
      </p>
    </div>

    <div class="text-center mt-3">
      <div class="inline-flex items-center space-x-2 bg-blue-600 px-4 py-2 rounded-lg">
        <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
        <span class="text-sm font-semibold">Currently Testing: <span id="current-testing-symbol" class="font-mono">--</span></span>
      </div>
      <div class="text-xs text-gray-400 mt-1">
        Row <span id="testing-row-number">-</span> ‚Ä¢
        Queue <span id="queue-size">0</span> ‚Ä¢
        Ready: <span id="ready-count" class="text-green-400">0</span>/<span id="total-count">0</span>
      </div>
    </div>
  </div>

  <!-- Broker Status -->
  <div class="mx-4 mb-4 bg-gray-800 rounded-lg p-4">
    <h2 class="text-xl font-semibold mb-3">Broker Status</h2>
    <div id="exchange-status" class="grid grid-cols-1 md:grid-cols-5 gap-4"></div>
  </div>

  <!-- Rolling Belts -->
  <div class="mb-4 bg-black border-y border-gray-700">
    <div class="relative overflow-hidden py-3">
      <div id="main-ticker" class="flex animate-scroll whitespace-nowrap"></div>
    </div>
    <div class="space-y-1">
      <div class="relative overflow-hidden bg-gray-900 py-2">
        <div id="flow-1" class="flex animate-scroll-reverse whitespace-nowrap"></div>
      </div>
      <div class="relative overflow-hidden bg-gray-900 py-2">
        <div id="flow-2" class="flex animate-scroll whitespace-nowrap"></div>
      </div>
    </div>
  </div>

  <!-- Detailed Scan Results -->
  <div class="mx-4 bg-gray-800 rounded-lg p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-xl font-semibold">Detailed Scan Results (Color-Coded)</h2>
      <div class="flex items-center space-x-2 text-sm">
        <div class="w-3 h-3 bg-blue-500 rounded animate-pulse"></div>
        <span class="text-gray-400">Row <span id="testing-row-number-2">-</span> Currently Being Analyzed</span>
      </div>
    </div>
    <div class="overflow-hidden">
      <div class="grid grid-cols-10 gap-2 text-sm font-semibold text-gray-400 mb-2 px-2">
        <div>Broker</div><div>Symbol</div><div>Status</div><div>Price</div><div>Change</div>
        <div>Volume</div><div>RSI</div><div>Signal</div><div>Filters</div><div>Action</div>
      </div>
      <div id="scan-results" class="max-h-96 overflow-y-auto space-y-1"></div>
    </div>
  </div>

  <div class="m-4 text-center">
    <a href="/" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300">
      ‚Üê Back to Dashboard
    </a>
  </div>

  <!-- Legend -->
  <div class="m-4 bg-gray-800 rounded-lg p-4">
    <h3 class="text-lg font-semibold mb-2">Smart Filter System & Color Legend</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
      <div class="space-y-2">
        <div><strong>Filter 1:</strong> RSI Extremes (< 25 or > 75)</div>
        <div><strong>Filter 2:</strong> ATR > 1% (volatility)</div>
        <div><strong>Filter 3:</strong> Volume spike OR Big move</div>
        <div><strong>Filter 4:</strong> Recently traded (< 60 sec)</div>
      </div>
      <div class="space-y-2">
        <div class="flex items-center space-x-2"><div class="w-4 h-4 bg-green-500 rounded"></div><span><strong>GREEN</strong> - All filters passed, ready to trade</span></div>
        <div class="flex items-center space-x-2"><div class="w-4 h-4 bg-yellow-400 rounded"></div><span><strong>YELLOW</strong> - Some filters failed OR out of trading hours</span></div>
        <div class="flex items-center space-x-2"><div class="w-4 h-4 bg-red-500 rounded"></div><span><strong>RED</strong> - Currently trading</span></div>
        <div class="flex items-center space-x-2"><div class="w-4 h-4 bg-yellow-800 rounded"></div><span><strong>BROWN</strong> - Blocked (same broker)</span></div>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    let exchanges = {}, scanData = [], tickerItems = [];
    const testingRowIndex = 3;
    let activeTradeSymbol = null;
    let activeTradeExchange = null;
    let activeTradeExchangeNorm = null;
    let activePopupWin = null;

    const MAX_CONCURRENT = 1;
    const MIN_GAP_BETWEEN_MS = 45_000;
    const BROKER_COOLDOWN_MS = 120_000;

    let lastPopupAt = 0;
    let lastByBroker = {};
    let popupQueue = [];
    let isOpening = false;

    const el = id => document.getElementById(id);
    const normEx = s => String(s || "").toUpperCase().replace(/[^A-Z]/g, "");

    // --- Trading hours checker ---
    function isMarketOpen(exchange) {
      const now = new Date();
      const day = now.getDay(); // 0=Sunday, 6=Saturday
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const timeInMinutes = hours * 60 + minutes;

      const exNorm = normEx(exchange);

      // Crypto markets: 24/7
      if (exNorm === 'CRYPTO') {
        return true;
      }

      // Forex: Closed on weekends (Saturday & Sunday)
      if (exNorm === 'FOREX') {
        return day !== 0 && day !== 6;
      }

      // Stock markets (NYSE, NASDAQ, ALPACA): Mon-Fri, 9:30 AM - 4:00 PM ET
      // Converting to your local time (PST/PDT) - assuming this runs in browser local time
      // For simplicity, using a basic weekday + hour check
      // NYSE/NASDAQ: Closed on weekends
      if (exNorm === 'NYSE' || exNorm === 'NASDAQ' || exNorm === 'ALPACA') {
        if (day === 0 || day === 6) return false; // Weekend
        // Market hours: 9:30 AM - 4:00 PM ET (convert if needed)
        // Using 6:30 AM - 1:00 PM PST as approximate conversion
        const marketOpen = 6 * 60 + 30;  // 6:30 AM PST
        const marketClose = 13 * 60;      // 1:00 PM PST
        return timeInMinutes >= marketOpen && timeInMinutes < marketClose;
      }

      // Futures: Closed on weekends (Saturday & Sunday)
      // Some markets open Sunday evening, but simplified to closed all weekend
      if (exNorm === 'FUTURES') {
        if (day === 0 || day === 6) return false; // Closed Saturday and Sunday
        return true; // Open Mon-Fri
      }

      return true; // Default to open for unknown exchanges
    }

    // --- Smart filter checker ---
    function checkFilters(item) {
      const rsiPass = item.rsi < 25 || item.rsi > 75;
      const atrPass = item.atr_pct > 1.0;
      const volumePass = item.volume_ratio > 1.5 || Math.abs(item.change) > 2.0;
      const recentPass = item.last_trade_seconds < 60;

      const allPassed = rsiPass && atrPass && volumePass && recentPass;
      const score = [rsiPass, atrPass, volumePass, recentPass].filter(Boolean).length;

      return { allPassed, score, rsiPass, atrPass, volumePass, recentPass };
    }

    // --- Generate sample data (KEEP ORIGINAL) ---
    function generateSampleExchangeData() {
      exchanges = {
        'ALPACA': { scanning: true, activeSymbol: null, symbolCount: 250 },
        'CRYPTO': { scanning: true, activeSymbol: null, symbolCount: 100 },
        'FOREX':  { scanning: true, activeSymbol: null, symbolCount: 50 },
        'NYSE':   { scanning: true, activeSymbol: null, symbolCount: 200 },
        'FUTURES':{ scanning: true, activeSymbol: null, symbolCount: 30 }
      };
    }

    function generateSampleScanData() {
      const symbols = [
        {symbol: 'BTC/USD', exchange: 'CRYPTO'},
        {symbol: 'ETH/USD', exchange: 'CRYPTO'},
        {symbol: 'AAPL',    exchange: 'ALPACA'},
        {symbol: 'TSLA',    exchange: 'ALPACA'},
        {symbol: 'NVDA',    exchange: 'ALPACA'},
        {symbol: 'SPY',     exchange: 'NYSE'},
        {symbol: 'QQQ',     exchange: 'NYSE'},
        {symbol: 'MSFT',    exchange: 'NYSE'},
        {symbol: 'AMZN',    exchange: 'NYSE'},
        {symbol: 'GOOGL',   exchange: 'ALPACA'},
        {symbol: 'META',    exchange: 'NYSE'},
        {symbol: 'NFLX',    exchange: 'ALPACA'},
        {symbol: 'AMD',     exchange: 'NYSE'},
        {symbol: 'INTC',    exchange: 'NASDAQ'},
        {symbol: 'GC-GOLD', exchange: 'FUTURES'},  // Gold futures
        {symbol: 'ES-SPX',  exchange: 'FUTURES'},  // S&P 500 E-mini futures
        {symbol: 'CL-OIL',  exchange: 'FUTURES'}   // Crude Oil futures
      ];

      scanData = symbols.map(({symbol, exchange}) => {
        let rsi, atr_pct, volume_ratio, last_trade_seconds;

        // Give BTC and ETH good values so they pass filters
        if (symbol === 'BTC/USD' || symbol === 'ETH/USD') {
          rsi = Math.random() > 0.5 ? 20 : 78;  // Extreme RSI
          atr_pct = 2.5;  // Good volatility
          volume_ratio = 2.0;  // Good volume
          last_trade_seconds = 30;  // Recent trade
        } else {
          rsi = (Math.random() * 100).toFixed(1);
          atr_pct = (Math.random() * 4).toFixed(2);
          volume_ratio = (Math.random() * 3).toFixed(2);
          last_trade_seconds = Math.floor(Math.random() * 120);
        }

        const signal = rsi < 30 ? 'BUY' : rsi > 70 ? 'SELL' : 'NEUTRAL';

        const item = {
          symbol, exchange,
          price: (Math.random() * 500 + 50).toFixed(2),
          change: ((Math.random() - 0.5) * 10).toFixed(2),
          volume: Math.floor(Math.random() * 1_000_000).toLocaleString(),
          rsi: parseFloat(rsi),
          signal,
          quantity: exchange === 'CRYPTO' ? 0.01 : 10,
          atr_pct: parseFloat(atr_pct),
          volume_ratio: parseFloat(volume_ratio),
          last_trade_seconds
        };

        // Add filter results
        item.filters = checkFilters(item);
        return item;
      });
    }

    function generateSampleTickerData() {
      const symbols = [
        {symbol: 'BTC/USD', exchange: 'CRYPTO'},
        {symbol: 'ETH/USD', exchange: 'CRYPTO'},
        {symbol: 'AAPL', exchange: 'ALPACA'},
        {symbol: 'TSLA', exchange: 'ALPACA'},
        {symbol: 'NVDA', exchange: 'ALPACA'},
        {symbol: 'SPY', exchange: 'NYSE'},
        {symbol: 'QQQ', exchange: 'NYSE'},
        {symbol: 'MSFT', exchange: 'NYSE'},
        {symbol: 'AMZN', exchange: 'NYSE'},
        {symbol: 'GOOGL', exchange: 'ALPACA'},
        {symbol: 'GC-GOLD', exchange: 'FUTURES'},  // Gold futures
        {symbol: 'ES-SPX', exchange: 'FUTURES'},  // S&P 500 E-mini futures
        {symbol: 'CL-OIL', exchange: 'FUTURES'}   // Crude Oil futures
      ];

      tickerItems = symbols.map(({symbol, exchange}) => {
        const rsi = Math.random() * 100;
        const atr_pct = Math.random() * 4;
        const volume_ratio = Math.random() * 3;
        const last_trade_seconds = Math.floor(Math.random() * 120);

        const item = {
          symbol, exchange,
          price: (Math.random() * 500 + 50).toFixed(2),
          change: ((Math.random() - 0.5) * 10).toFixed(2),
          signal: Math.random() > 0.6 ? (Math.random() > 0.5 ? 'BUY' : 'SELL') : 'NEUTRAL',
          rsi, atr_pct, volume_ratio, last_trade_seconds
        };

        item.filters = checkFilters(item);
        return item;
      });
    }

    // --- UI renderers ---
    function updateExchangeStatusDisplay() {
      const container = el('exchange-status');
      if (!container) return;
      container.innerHTML = '';
      Object.entries(exchanges).forEach(([name, info]) => {
        const nameNorm = normEx(name);
        const isAvailable = !activeTradeExchangeNorm || activeTradeExchangeNorm !== nameNorm;
        const marketOpen = isMarketOpen(name);

        let statusClass, statusColor, statusText;

        if (!marketOpen) {
          // Out of trading hours - YELLOW
          statusClass = 'broker-out-of-hours';
          statusColor = 'text-yellow-300';
          statusText = 'üü° CLOSED (Out of Hours)';
        } else if (isAvailable) {
          // Available - GREEN
          statusClass = 'broker-available';
          statusColor = 'text-green-300';
          statusText = 'üü¢ AVAILABLE';
        } else {
          // Trading - ORANGE
          statusClass = 'broker-busy';
          statusColor = 'text-orange-300';
          statusText = 'üî¥ TRADING: ' + (activeTradeSymbol ?? '');
        }

        const div = document.createElement('div');
        div.className = `${statusClass} border-2 rounded-lg p-3 transition-all duration-500`;
        div.innerHTML = `
          <div class="font-bold text-lg">${name}</div>
          <div class="text-sm mt-1">${info.symbolCount ?? '--'} symbols</div>
          <div class="text-xs mt-2 ${statusColor}">
            ${statusText}
          </div>
        `;
        container.appendChild(div);
      });
    }

    function updateTickerDisplay() {
      ['main-ticker', 'flow-1', 'flow-2'].forEach(containerId => {
        const container = el(containerId);
        if (!container) return;
        container.innerHTML = '';
        tickerItems.forEach(item => {
          const exNorm = normEx(item.exchange);
          const marketOpen = isMarketOpen(item.exchange);
          let klass = 'ticker-available';
          let indicator = 'üü¢'; // Default green dot

          // Priority order: Active Trade (RED) > Blocked (BROWN) > Out-of-hours (YELLOW) > Available (GREEN)
          // NOTE: Horizontal ticker does NOT show yellow for failed filters - only for out-of-hours
          if (activeTradeSymbol && item.symbol === activeTradeSymbol) {
            klass = 'ticker-active-trade';
            indicator = 'üî¥';
          } else if (activeTradeExchangeNorm && exNorm === activeTradeExchangeNorm) {
            klass = 'ticker-blocked';
            indicator = 'üü§';
          } else if (!marketOpen) {
            indicator = 'üü°'; // Yellow dot ONLY for out of hours
          }
          // Removed: filter check - horizontal ticker only cares about trading hours

          const div = document.createElement('div');
          div.className = `${klass} px-4 py-2 mx-2 rounded inline-block transition-colors duration-500`;
          div.innerHTML = `
            <span class="mr-1">${indicator}</span>
            <span class="font-mono font-semibold">${item.symbol}</span>
            <span class="ml-2">$${Number(item.price).toFixed(2)}</span>
            <span class="ml-2 ${parseFloat(item.change) >= 0 ? 'text-green-300' : 'text-red-300'}">${Number(item.change).toFixed(2)}%</span>
            ${item.signal && item.signal !== 'NEUTRAL' ? `<span class="ml-1 text-xs ${item.signal === 'BUY' ? 'text-green-300' : 'text-red-300'}">${item.signal}</span>` : ''}`;
          container.appendChild(div);
        });
      });
    }

    function updateScanResultsDisplay() {
      const container = el('scan-results');
      if (!container) return;
      container.innerHTML = '';

      let readyCount = 0;

      scanData.forEach((row, index) => {
        const isTestingRow = (index === testingRowIndex);
        const rowExNorm = normEx(row.exchange);
        const marketOpen = isMarketOpen(row.exchange);
        let statusClass = '';
        let statusText = '';

        if (isTestingRow) {
          statusClass = 'row-testing';
          statusText = 'üîç TESTING NOW';
        } else if (row.symbol === activeTradeSymbol) {
          statusClass = 'symbol-busy-active';
          statusText = 'üî¥ TRADING';
        } else if (activeTradeExchangeNorm && rowExNorm === activeTradeExchangeNorm) {
          statusClass = 'symbol-busy-blocked';
          statusText = 'üü§ BLOCKED';
        } else if (!marketOpen) {
          // Market is closed - show as yellow even if filters would pass
          statusClass = 'symbol-filter-failed';  // YELLOW
          statusText = 'üü° MARKET CLOSED';
        } else if (row.filters.allPassed) {
          statusClass = 'symbol-filter-passed';  // GREEN
          statusText = 'üü¢ READY';
          readyCount++;
        } else {
          statusClass = 'symbol-filter-failed';  // YELLOW
          statusText = 'üü° NEEDS WORK';
        }

        const filterScore = `${row.filters.score}/4`;
        const filterColor = row.filters.score === 4 ? 'text-green-400' : row.filters.score >= 2 ? 'text-yellow-400' : 'text-red-400';

        const div = document.createElement('div');
        div.className = `grid grid-cols-10 gap-2 p-2 mb-1 rounded ${statusClass} text-sm items-center`;
        div.innerHTML = `
          <div class="font-semibold">${row.exchange}</div>
          <div class="font-mono font-bold ${isTestingRow ? 'text-xl' : ''}">${row.symbol}</div>
          <div class="text-xs font-semibold">${statusText}</div>
          <div>$${row.price}</div>
          <div class="${parseFloat(row.change) >= 0 ? 'text-green-400' : 'text-red-400'}">${row.change}%</div>
          <div class="text-xs">${row.volume}</div>
          <div class="${parseFloat(row.rsi) < 30 ? 'text-green-400 font-bold' : parseFloat(row.rsi) > 70 ? 'text-red-400 font-bold' : ''}">${row.rsi}</div>
          <div class="font-semibold ${row.signal === 'BUY' ? 'text-green-400' : row.signal === 'SELL' ? 'text-red-400' : 'text-gray-400'}">${row.signal}</div>
          <div class="text-xs font-bold ${filterColor}">${filterScore}</div>
          <div class="text-xs">
            ${isTestingRow ? 'üéØ ANALYZING' : row.filters.allPassed ? '‚úÖ READY' : '‚ö†Ô∏è WAIT'}
          </div>`;
        container.appendChild(div);
      });

      if (scanData[testingRowIndex]) {
        el('current-testing-symbol').textContent = scanData[testingRowIndex].symbol;
        el('testing-row-number').textContent = testingRowIndex + 1;
        el('testing-row-number-2').textContent = testingRowIndex + 1;
      }
      el('queue-size').textContent = popupQueue.length;
      el('ready-count').textContent = readyCount;
      el('total-count').textContent = scanData.length;
    }

    // --- Rotation & heartbeat ---
    function conveyorBeltRotate() {
      if (scanData.length === 0) return;
      const first = scanData.shift();
      scanData.push(first);
      updateScanResultsDisplay();
      checkAndOpenPopups();
    }

    function tickerHeartbeat() {
      tickerItems.forEach(item => {
        const base = parseFloat(item.price);
        const delta = (Math.random() - 0.5) * 0.8;
        const next = Math.max(0.01, base + delta);
        item.price = next.toFixed(2);
        item.change = (((next - base) / Math.max(0.01, base)) * 100).toFixed(2);
      });
      updateTickerDisplay();
    }

    // --- Popup throttle/queue ---
    function brokerCooling(nex) {
      const t = lastByBroker[nex] || 0;
      return (Date.now() - t) < BROKER_COOLDOWN_MS;
    }

    function eligibleNow(row) {
      const nex = normEx(row.exchange);
      if (activePopupWin && !activePopupWin.closed) return false;
      if (activeTradeExchangeNorm && nex === activeTradeExchangeNorm) return false;
      if (Date.now() - lastPopupAt < MIN_GAP_BETWEEN_MS) return false;
      if (brokerCooling(nex)) return false;
      return true;
    }

    function enqueuePopup(row) {
      const nex = normEx(row.exchange);
      const already = popupQueue.some(r => r.symbol === row.symbol && normEx(r.exchange) === nex);
      if (!already) popupQueue.push({...row});
      el('queue-size').textContent = popupQueue.length;
    }

    function processPopupQueue() {
      if (isOpening) return;
      if (popupQueue.length === 0) return;
      const cand = popupQueue[0];
      if (!eligibleNow(cand)) return;

      isOpening = true;
      popupQueue.shift();
      openTradePopupForSignal(cand);
      lastPopupAt = Date.now();

      const watch = setInterval(() => {
        if (!activePopupWin || activePopupWin.closed) {
          clearInterval(watch);
          activeTradeSymbol = null;
          activeTradeExchange = null;
          activeTradeExchangeNorm = null;
          isOpening = false;
          updateExchangeStatusDisplay();
          updateScanResultsDisplay();
          updateTickerDisplay();
          setTimeout(processPopupQueue, 300);
        }
      }, 1000);
    }

    function checkAndOpenPopups() {
      const row = scanData[testingRowIndex];
      if (!row) return;

      // Check if market is open for this exchange
      const marketOpen = isMarketOpen(row.exchange);

      // ONLY open popup if market is open AND ALL filters passed AND valid signal
      if (marketOpen && (row.signal === 'BUY' || row.signal === 'SELL') && row.filters.allPassed) {
        enqueuePopup(row);
      }
      processPopupQueue();
    }

    // --- Popup open ---
    function openTradePopupForSignal(signalData) {
      activeTradeSymbol = signalData.symbol;
      activeTradeExchange = signalData.exchange;
      activeTradeExchangeNorm = normEx(signalData.exchange);

      updateScanResultsDisplay();
      updateExchangeStatusDisplay();
      updateTickerDisplay();

      const expandUrl = `/trade-full?symbol=${encodeURIComponent(signalData.symbol)}&exchange=${encodeURIComponent(signalData.exchange)}&qty=${encodeURIComponent(signalData.quantity||1)}&side=${encodeURIComponent(signalData.signal)}`;

      const params = new URLSearchParams({
        symbol: signalData.symbol,
        side: signalData.signal,
        qty: signalData.quantity || 1,
        exchange: signalData.exchange,
        price: signalData.price,
        change: signalData.change,
        rsi: signalData.rsi,
        signal: signalData.signal,
        expand_url: expandUrl,
        reason: `Smart Filter Passed: ${signalData.filters.score}/4`
      });

      activePopupWin = window.open(
        `/trade-popup-fixed?${params.toString()}`,
        'TradeWindow_' + signalData.symbol,
        'width=560,height=90,scrollbars=no,toolbar=no,menubar=no'
      );
      setTimeout(() => { isOpening = false; }, 500);
    }

    // --- Events from popup ---
    window.addEventListener('message', (event) => {
      if (event.data.type === 'TRADE_CLOSED') {
        const nex = normEx(event.data.exchange);
        lastByBroker[nex] = Date.now();
        activeTradeSymbol = null;
        activeTradeExchange = null;
        activeTradeExchangeNorm = null;
        updateExchangeStatusDisplay();
        updateScanResultsDisplay();
        updateTickerDisplay();
        setTimeout(processPopupQueue, 300);
      }
    });

    // --- Manual test buttons ---
    function openTradePopupTestStock() {
      openTradePopupForSignal({
        symbol:'AAPL', exchange:'ALPACA', signal:'BUY', quantity:10,
        price:'175.50', change:'+2.5', rsi:'22.3', volume:'1000000',
        filters: {allPassed: true, score: 4}
      });
    }

    function openTradePopupTestCrypto() {
      openTradePopupForSignal({
        symbol:'BTC/USD', exchange:'CRYPTO', signal:'BUY', quantity:0.01,
        price:'43250.00', change:'+3.2', rsi:'18.5', volume:'500000',
        filters: {allPassed: true, score: 4}
      });
    }

    window.openTradePopupTestStock = openTradePopupTestStock;
    window.openTradePopupTestCrypto = openTradePopupTestCrypto;

    // --- Boot ---
    function init() {
      generateSampleExchangeData();
      generateSampleScanData();
      generateSampleTickerData();
      updateExchangeStatusDisplay();
      updateTickerDisplay();
      updateScanResultsDisplay();

      setInterval(conveyorBeltRotate, 4000);
      setInterval(tickerHeartbeat, 1500);
      setInterval(() => {
        updateExchangeStatusDisplay();
        updateTickerDisplay();
      }, 5000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
