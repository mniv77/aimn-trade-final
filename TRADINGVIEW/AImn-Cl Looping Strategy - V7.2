// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© mniv77

 

//@version=5
strategy("AImn-Cl Looping Strategy - V7.2 (JSON Sync)", overlay=true)

// ====================================================================
// SECTION 1: MODE SELECTOR
// ====================================================================
tradeMode = input.string("SELL", title="ðŸŽ¯ Trade Mode", options=["BUY", "SELL"], group="ðŸŽ® Mode Selection")
isBuyMode = tradeMode == "BUY"
isSellMode = tradeMode == "SELL"

// ====================================================================
// SECTION 2: PROGRAMMABLE PARAMETERS (CLEANED FOR V7.2)
// ====================================================================
// RSI Real Configuration
rsiWindow = input.int(100, title="RSI Real Window", minval=10, group="ðŸŽ¯ RSI Real Settings")

// Buy Mode RSI Levels
oversoldLevel_Int = input.int(30, title="Oversold Level (whole)", minval=1, maxval=99, group="ðŸŸ¢ BUY Mode - RSI Levels")
oversoldLevel_Dec = input.float(0.0, title="Oversold Level (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - RSI Levels")
oversoldLevel = oversoldLevel_Int + oversoldLevel_Dec

rsiExitLevelBuy_Int = input.int(70, title="RSI Exit Level Buy (whole)", minval=1, maxval=99, group="ðŸŸ¢ BUY Mode - RSI Levels") 
rsiExitLevelBuy_Dec = input.float(0.0, title="RSI Exit Level Buy (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - RSI Levels")
rsiExitLevelBuy = rsiExitLevelBuy_Int + rsiExitLevelBuy_Dec

// Sell Mode RSI Levels
overboughtLevel_Int = input.int(70, title="Overbought Level (whole)", minval=1, maxval=99, group="ðŸ”´ SELL Mode - RSI Levels")
overboughtLevel_Dec = input.float(0.0, title="Overbought Level (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - RSI Levels")
overboughtLevel = overboughtLevel_Int + overboughtLevel_Dec

rsiExitLevelSell_Int = input.int(30, title="RSI Exit Level Sell (whole)", minval=1, maxval=99, group="ðŸ”´ SELL Mode - RSI Levels") 
rsiExitLevelSell_Dec = input.float(0.0, title="RSI Exit Level Sell (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - RSI Levels")
rsiExitLevelSell = rsiExitLevelSell_Int + rsiExitLevelSell_Dec

// MACD Configuration
fastLength = input.int(12, title="MACD Fast Length", minval=1, group="ðŸ“Š MACD Settings")
slowLength = input.int(26, title="MACD Slow Length", minval=1, group="ðŸ“Š MACD Settings")
signalLength = input.int(9, title="MACD Signal Length", minval=1, group="ðŸ“Š MACD Settings")

// BUY Mode Volume Configuration
volMALengthBuy = input.int(20, title="Volume MA Length", minval=5, group="ðŸŸ¢ BUY Mode - Volume Settings")
volThresholdBuy = input.float(1.2, title="Volume Threshold Multiplier", minval=1.0, step=0.1, group="ðŸŸ¢ BUY Mode - Volume Settings")
useVolumeFilterBuy = input.bool(true, title="Use Volume Confirmation", group="ðŸŸ¢ BUY Mode - Volume Settings")

// SELL Mode Volume Configuration
volMALengthSell = input.int(20, title="Volume MA Length", minval=5, group="ðŸ”´ SELL Mode - Volume Settings")
volThresholdSell = input.float(1.2, title="Volume Threshold Multiplier", minval=1.0, step=0.1, group="ðŸ”´ SELL Mode - Volume Settings")
useVolumeFilterSell = input.bool(true, title="Use Volume Confirmation", group="ðŸ”´ SELL Mode - Volume Settings")

// BUY Mode ATR Volatility Configuration
atrLengthBuy = input.int(14, title="ATR Length", minval=1, group="ðŸŸ¢ BUY Mode - Volatility Settings")
atrMALengthBuy = input.int(20, title="ATR MA Length", minval=1, group="ðŸŸ¢ BUY Mode - Volatility Settings")
atrThresholdBuy = input.float(1.3, title="ATR Expansion Multiplier", minval=1.0, step=0.1, group="ðŸŸ¢ BUY Mode - Volatility Settings")
useATRFilterBuy = input.bool(true, title="Use ATR Volatility Filter", group="ðŸŸ¢ BUY Mode - Volatility Settings")

// SELL Mode ATR Volatility Configuration
atrLengthSell = input.int(14, title="ATR Length", minval=1, group="ðŸ”´ SELL Mode - Volatility Settings")
atrMALengthSell = input.int(20, title="ATR MA Length", minval=1, group="ðŸ”´ SELL Mode - Volatility Settings")
atrThresholdSell = input.float(1.3, title="ATR Expansion Multiplier", minval=1.0, step=0.1, group="ðŸ”´ SELL Mode - Volatility Settings")
useATRFilterSell = input.bool(true, title="Use ATR Volatility Filter", group="ðŸ”´ SELL Mode - Volatility Settings")

// 3-LINES PARAMETERS - BUY MODE
stopLossPercentBuy_Int = input.int(2, title="Stop Loss % (whole)", minval=0, group="ðŸŸ¢ BUY Mode - 3-Lines Exit")
stopLossPercentBuy_Dec = input.float(0.0, title="Stop Loss % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - 3-Lines Exit")
stopLossPercentBuy = (stopLossPercentBuy_Int + stopLossPercentBuy_Dec) / 100

// Early Trailing (Loose)
earlyTrailStartBuy_Int = input.int(1, title="Early Trail Start % (whole)", minval=0, group="ðŸŸ¢ BUY Mode - Early Trailing")
earlyTrailStartBuy_Dec = input.float(0.0, title="Early Trail Start % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - Early Trailing")
earlyTrailStartPercentBuy = (earlyTrailStartBuy_Int + earlyTrailStartBuy_Dec) / 100

earlyTrailMinusBuy_Int = input.int(15, title="Early Trail Minus % (whole)", minval=0, group="ðŸŸ¢ BUY Mode - Early Trailing")
earlyTrailMinusBuy_Dec = input.float(0.0, title="Early Trail Minus % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - Early Trailing")
earlyTrailMinusPercentBuy = (earlyTrailMinusBuy_Int + earlyTrailMinusBuy_Dec) / 100

// Peak Trailing (Tight)
peakTrailStartBuy_Int = input.int(5, title="Peak Trail Start % (whole)", minval=1, group="ðŸŸ¢ BUY Mode - Peak Trailing")
peakTrailStartBuy_Dec = input.float(0.0, title="Peak Trail Start % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - Peak Trailing")
peakTrailStartPercentBuy = (peakTrailStartBuy_Int + peakTrailStartBuy_Dec) / 100

peakTrailMinusBuy_Int = input.int(0, title="Peak Trail Minus % (whole)", minval=0, group="ðŸŸ¢ BUY Mode - Peak Trailing")
peakTrailMinusBuy_Dec = input.float(0.5, title="Peak Trail Minus % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - Peak Trailing")
peakTrailMinusPercentBuy = (peakTrailMinusBuy_Int + peakTrailMinusBuy_Dec) / 100

// 3-LINES PARAMETERS - SELL MODE
stopLossPercentSell_Int = input.int(2, title="Stop Loss % (whole)", minval=0, group="ðŸ”´ SELL Mode - 3-Lines Exit")
stopLossPercentSell_Dec = input.float(0.0, title="Stop Loss % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - 3-Lines Exit")
stopLossPercentSell = (stopLossPercentSell_Int + stopLossPercentSell_Dec) / 100

// Early Trailing (Loose)
earlyTrailStartSell_Int = input.int(1, title="Early Trail Start % (whole)", minval=0, group="ðŸ”´ SELL Mode - Early Trailing")
earlyTrailStartSell_Dec = input.float(0.0, title="Early Trail Start % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - Early Trailing")
earlyTrailStartPercentSell = (earlyTrailStartSell_Int + earlyTrailStartSell_Dec) / 100

earlyTrailMinusSell_Int = input.int(15, title="Early Trail Minus % (whole)", minval=0, group="ðŸ”´ SELL Mode - Early Trailing")
earlyTrailMinusSell_Dec = input.float(0.0, title="Early Trail Minus % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - Early Trailing")
earlyTrailMinusPercentSell = (earlyTrailMinusSell_Int + earlyTrailMinusSell_Dec) / 100

// Peak Trailing (Tight)
peakTrailStartSell_Int = input.int(5, title="Peak Trail Start % (whole)", minval=1, group="ðŸ”´ SELL Mode - Peak Trailing")
peakTrailStartSell_Dec = input.float(0.0, title="Peak Trail Start % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - Peak Trailing")
peakTrailStartPercentSell = (peakTrailStartSell_Int + peakTrailStartSell_Dec) / 100

peakTrailMinusSell_Int = input.int(0, title="Peak Trail Minus % (whole)", minval=0, group="ðŸ”´ SELL Mode - Peak Trailing")
peakTrailMinusSell_Dec = input.float(0.5, title="Peak Trail Minus % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - Peak Trailing")
peakTrailMinusPercentSell = (peakTrailMinusSell_Int + peakTrailMinusSell_Dec) / 100

// Display & Alerts
enableAlerts = input.bool(true, title="Enable Alerts", group="ðŸ”” Settings")
showLines = input.bool(true, title="Show All Lines", group="ðŸ”” Settings")
showSignals = input.bool(true, title="Show Entry/Exit Signals", group="ðŸ”” Settings")
showParamDisplay = input.bool(false, title="ðŸ“‹ Show Parameter Display for Copy", group="ðŸ”” Settings")

// ====================================================================
// NEW PARAMETERS - HOURLY TIME-BASED DECAY
// ====================================================================
// BUY Mode Hourly Time Decay
useHourlyDecayBuy = input.bool(true, title="âœ… Enable HOURLY Time-Decay", group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")

initialProfitBuy_Int = input.int(3, title="Initial Profit Required %", minval=0, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
initialProfitBuy_Dec = input.float(0.0, title="Initial Profit Decimal", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
initialProfitBuy = initialProfitBuy_Int + initialProfitBuy_Dec

startLoweringAfterHoursBuy_Int = input.int(2, title="Start Lowering After HOURS", minval=0, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
startLoweringAfterHoursBuy_Dec = input.float(0.0, title="Start Lowering Hours (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
startLoweringAfterHoursBuy = startLoweringAfterHoursBuy_Int + startLoweringAfterHoursBuy_Dec

lowerByPercentPerHourBuy_Int = input.int(0, title="Lower By % Each HOUR (whole)", minval=0, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
lowerByPercentPerHourBuy_Dec = input.float(0.5, title="Lower By % Each HOUR (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
lowerByPercentPerHourBuy = lowerByPercentPerHourBuy_Int + lowerByPercentPerHourBuy_Dec

minProfitFloorBuy_Int = input.int(0, title="Minimum Profit Floor % (whole)", minval=0, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
minProfitFloorBuy_Dec = input.float(0.0, title="Minimum Profit Floor % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸŸ¢ BUY Mode - â° HOURLY Decay")
minProfitFloorBuy = minProfitFloorBuy_Int + minProfitFloorBuy_Dec

// SELL Mode Hourly Time Decay
useHourlyDecaySell = input.bool(true, title="âœ… Enable HOURLY Time-Decay", group="ðŸ”´ SELL Mode - â° HOURLY Decay")

initialProfitSell_Int = input.int(3, title="Initial Profit Required %", minval=0, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
initialProfitSell_Dec = input.float(0.0, title="Initial Profit Decimal", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
initialProfitSell = initialProfitSell_Int + initialProfitSell_Dec

startLoweringAfterHoursSell_Int = input.int(2, title="Start Lowering After HOURS", minval=0, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
startLoweringAfterHoursSell_Dec = input.float(0.0, title="Start Lowering Hours (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
startLoweringAfterHoursSell = startLoweringAfterHoursSell_Int + startLoweringAfterHoursSell_Dec

lowerByPercentPerHourSell_Int = input.int(0, title="Lower By % Each HOUR (whole)", minval=0, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
lowerByPercentPerHourSell_Dec = input.float(0.5, title="Lower By % Each HOUR (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
lowerByPercentPerHourSell = lowerByPercentPerHourSell_Int + lowerByPercentPerHourSell_Dec

minProfitFloorSell_Int = input.int(0, title="Minimum Profit Floor % (whole)", minval=0, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
minProfitFloorSell_Dec = input.float(0.0, title="Minimum Profit Floor % (decimal)", minval=0.0, maxval=0.9, step=0.1, group="ðŸ”´ SELL Mode - â° HOURLY Decay")
minProfitFloorSell = minProfitFloorSell_Int + minProfitFloorSell_Dec

// ====================================================================
// SECTION 3: CALCULATIONS
// ====================================================================
// RSI Real Calculation
recentHigh = ta.highest(high, rsiWindow)
recentLow = ta.lowest(low, rsiWindow)
rsiReal = (close - recentLow) / (recentHigh - recentLow) * 100
rsiReal := na(rsiReal) ? 50 : rsiReal

// MACD Calculation 
[macdLine, signalLine, histLine] = ta.macd(close, fastLength, slowLength, signalLength)
macdLine := na(macdLine) ? 0 : macdLine
signalLine := na(signalLine) ? 0 : signalLine

// Mode-specific Volume Analysis
volMABuy = ta.sma(volume, volMALengthBuy)
volRatioBuy = volume / volMABuy
volMASell = ta.sma(volume, volMALengthSell)
volRatioSell = volume / volMASell

// OBV Calculation
obv = ta.cum(math.sign(close - close[1]) * volume)
obvMA = ta.sma(obv, 20)

// Mode-specific Volume Direction Analysis
priceChange = (close - close[1]) / close[1] * 100
volumeDirectionBuy = 0.0
volumeDirectionSell = 0.0

if volume > volMABuy * volThresholdBuy
    if priceChange > 0.1
        volumeDirectionBuy := 1
    else if priceChange < -0.1
        volumeDirectionBuy := -1

if volume > volMASell * volThresholdSell
    if priceChange > 0.1
        volumeDirectionSell := 1
    else if priceChange < -0.1
        volumeDirectionSell := -1

// Mode-specific ATR Volatility Analysis
atrBuy = ta.atr(atrLengthBuy)
atrMABuy = ta.sma(atrBuy, atrMALengthBuy)
atrRatioBuy = atrBuy / atrMABuy
isHighVolatilityBuy = atrBuy > atrMABuy * atrThresholdBuy

atrSell = ta.atr(atrLengthSell)
atrMASell = ta.sma(atrSell, atrMALengthSell)
atrRatioSell = atrSell / atrMASell
isHighVolatilitySell = atrSell > atrMASell * atrThresholdSell

// Market Movement Quality
marketMovingBuy = not useATRFilterBuy or isHighVolatilityBuy
marketMovingSell = not useATRFilterSell or isHighVolatilitySell

// ====================================================================
// SECTION 4: STATE MANAGEMENT
// ====================================================================
var bool isOrderActive = false
var float orderEntryPrice = na
var int orderEntryBar = na
var int orderEntryTime = na
var float trailingTop = na
var bool trailingActive = false
var int totalTrades = 0
var float totalRealizedPnL = 0.0
var string lastExitReason = ""
var float lastExitPnL = na

// Dual Trailing State
var bool earlyTrailingActive = false
var bool peakTrailingActive = false
var float currentTrailingPercent = na

// COMPOUND TRACKING VARIABLES
var float initialBalance = 1000.0
var float currentBalance = 1000.0
var float compoundTotalPercent = 0.0

// 3-Lines Variables
var float entryPriceLine = na
var float earlyTrailStartLine = na
var float peakTrailStartLine = na
var float stopLossLine = na
var float trailingMinus = na
var float requiredProfitLine = na

// Clear lines when no position is active
if not isOrderActive
    entryPriceLine := na
    earlyTrailStartLine := na
    peakTrailStartLine := na
    stopLossLine := na
    trailingMinus := na
    requiredProfitLine := na
    orderEntryTime := na

// ====================================================================
// HOURLY TIME CALCULATION AND DYNAMIC PROFIT REQUIREMENT
// ====================================================================
hoursInTrade = 0.0
dynamicProfitRequired = 0.0

if isOrderActive and not na(orderEntryTime)
    millisecondsElapsed = time - orderEntryTime
    hoursInTrade := millisecondsElapsed / 3600000.0
    
    if isBuyMode and useHourlyDecayBuy
        if hoursInTrade < startLoweringAfterHoursBuy
            dynamicProfitRequired := initialProfitBuy
        else
            hoursElapsed = hoursInTrade - startLoweringAfterHoursBuy
            reduction = hoursElapsed * lowerByPercentPerHourBuy
            dynamicProfitRequired := math.max(minProfitFloorBuy, initialProfitBuy - reduction)
        
        requiredProfitLine := orderEntryPrice * (1 + dynamicProfitRequired / 100)
    
    else if isSellMode and useHourlyDecaySell
        if hoursInTrade < startLoweringAfterHoursSell
            dynamicProfitRequired := initialProfitSell
        else
            hoursElapsed = hoursInTrade - startLoweringAfterHoursSell
            reduction = hoursElapsed * lowerByPercentPerHourSell
            dynamicProfitRequired := math.max(minProfitFloorSell, initialProfitSell - reduction)
        
        requiredProfitLine := orderEntryPrice * (1 - dynamicProfitRequired / 100)

// ====================================================================
// SECTION 5: ENTRY CONDITIONS
// ====================================================================
buyRsiCondition = rsiReal <= oversoldLevel and not na(rsiReal)
buyMacdCondition = ta.crossover(macdLine, signalLine) and not na(macdLine) and not na(signalLine)
buyVolumeCondition = not useVolumeFilterBuy or (volumeDirectionBuy > 0 and obv > obvMA)
buyATRCondition = marketMovingBuy
buyEntry = isBuyMode and buyRsiCondition and buyMacdCondition and buyVolumeCondition and buyATRCondition and not isOrderActive and barstate.isconfirmed

sellRsiCondition = rsiReal >= overboughtLevel and not na(rsiReal)
sellMacdCondition = ta.crossunder(macdLine, signalLine) and not na(macdLine) and not na(signalLine)
sellVolumeCondition = not useVolumeFilterSell or (volumeDirectionSell < 0 and obv < obvMA)
sellATRCondition = marketMovingSell
sellEntry = isSellMode and sellRsiCondition and sellMacdCondition and sellVolumeCondition and sellATRCondition and not isOrderActive and barstate.isconfirmed

// ====================================================================
// SECTION 6: ORDER ENTRY PROCESSING
// ====================================================================
if buyEntry or sellEntry
    isOrderActive := true
    orderEntryPrice := close
    orderEntryBar := bar_index
    orderEntryTime := time
    trailingTop := na
    trailingActive := false
    earlyTrailingActive := false
    peakTrailingActive := false
    currentTrailingPercent := na
    
    if buyEntry
        entryPriceLine := orderEntryPrice
        earlyTrailStartLine := orderEntryPrice * (1 + earlyTrailStartPercentBuy)
        peakTrailStartLine := orderEntryPrice * (1 + peakTrailStartPercentBuy)
        stopLossLine := orderEntryPrice * (1 - stopLossPercentBuy)
        requiredProfitLine := orderEntryPrice * (1 + initialProfitBuy / 100)
        strategy.entry("BUY", strategy.long, comment="RSI:" + str.tostring(rsiReal, "#.##"))
    
    else if sellEntry
        entryPriceLine := orderEntryPrice
        earlyTrailStartLine := orderEntryPrice * (1 - earlyTrailStartPercentSell)
        peakTrailStartLine := orderEntryPrice * (1 - peakTrailStartPercentSell)
        stopLossLine := orderEntryPrice * (1 + stopLossPercentSell)
        requiredProfitLine := orderEntryPrice * (1 - initialProfitSell / 100)
        strategy.entry("SELL", strategy.short, comment="RSI:" + str.tostring(rsiReal, "#.##"))

// ====================================================================
// SECTION 7: PROFIT CALCULATIONS
// ====================================================================
closePLPercent = 0.0
if isOrderActive and not na(orderEntryPrice) and orderEntryPrice > 0
    if isBuyMode
        closePLPercent := ((close - orderEntryPrice) / orderEntryPrice) * 100
    else if isSellMode
        closePLPercent := ((orderEntryPrice - close) / orderEntryPrice) * 100

// ====================================================================
// SECTION 8: DUAL TRAILING LOGIC
// ====================================================================
if isOrderActive
    if isBuyMode
        if closePLPercent >= peakTrailStartPercentBuy * 100
            if not peakTrailingActive
                peakTrailingActive := true
                earlyTrailingActive := false
                trailingActive := true
                trailingTop := close
            else
                trailingTop := math.max(trailingTop, close)
            currentTrailingPercent := peakTrailMinusPercentBuy
            
        else if closePLPercent >= earlyTrailStartPercentBuy * 100
            if not earlyTrailingActive and not peakTrailingActive
                earlyTrailingActive := true
                trailingActive := true
                trailingTop := close
            else if earlyTrailingActive
                trailingTop := math.max(trailingTop, close)
            currentTrailingPercent := earlyTrailMinusPercentBuy
        
        if trailingActive and not na(trailingTop) and not na(currentTrailingPercent)
            trailingMinus := trailingTop * (1 - currentTrailingPercent)
    
    else if isSellMode
        if closePLPercent >= peakTrailStartPercentSell * 100
            if not peakTrailingActive
                peakTrailingActive := true
                earlyTrailingActive := false
                trailingActive := true
                trailingTop := close
            else
                trailingTop := math.min(trailingTop, close)
            currentTrailingPercent := peakTrailMinusPercentSell
            
        else if closePLPercent >= earlyTrailStartPercentSell * 100
            if not earlyTrailingActive and not peakTrailingActive
                earlyTrailingActive := true
                trailingActive := true
                trailingTop := close
            else if earlyTrailingActive
                trailingTop := math.min(trailingTop, close)
            currentTrailingPercent := earlyTrailMinusPercentSell
        
        if trailingActive and not na(trailingTop) and not na(currentTrailingPercent)
            trailingMinus := trailingTop * (1 + currentTrailingPercent)

// ====================================================================
// SECTION 9: EXIT CONDITIONS (CLEAN V7.2)
// ====================================================================
exitTrailing = false
exitStopLoss = false
exitRSI = false

if isOrderActive
    // GENERAL RULE: Profit must satisfy Hourly Decay requirement
    profitMeetsRequirement = closePLPercent >= dynamicProfitRequired
    
    if isBuyMode
        exitTrailing := trailingActive and not na(trailingMinus) and close < trailingMinus and profitMeetsRequirement
        exitStopLoss := not na(stopLossLine) and close <= stopLossLine and profitMeetsRequirement
        // RSI Exit: Now purely based on RSI Level + General Profit Requirement
        exitRSI := rsiReal >= rsiExitLevelBuy and profitMeetsRequirement
    
    else if isSellMode
        exitTrailing := trailingActive and not na(trailingMinus) and close > trailingMinus and profitMeetsRequirement
        exitStopLoss := not na(stopLossLine) and close >= stopLossLine and profitMeetsRequirement
        // RSI Exit: Now purely based on RSI Level + General Profit Requirement
        exitRSI := rsiReal <= rsiExitLevelSell and profitMeetsRequirement

orderExit = (exitTrailing or exitStopLoss or exitRSI) and barstate.isconfirmed

// ====================================================================
// SECTION 10 & 11: STRATEGY EXIT & PROCESSING
// ====================================================================
if orderExit
    if isBuyMode
        strategy.close("BUY", comment="EXIT")
    else if isSellMode
        strategy.close("SELL", comment="EXIT")

    tradeProfit = closePLPercent
    
    exitReasonCode = ""
    if exitTrailing
        exitReasonCode := peakTrailingActive ? "P" : "E"
    else if exitStopLoss
        exitReasonCode := "S"
    else if exitRSI
        exitReasonCode := "R"
    else
        exitReasonCode := "?"
    
    if showSignals
        labelColor = tradeProfit >= 0 ? color.green : color.red
        labelStyle = tradeProfit >= 0 ? label.style_label_up : label.style_label_down
        labelPosition = tradeProfit >= 0 ? low - (ta.atr(14) * 0.05) : high + (ta.atr(14) * 0.05)
        
        label.new(bar_index, labelPosition,
                  text=str.tostring(tradeProfit, "#.##") + "% " + exitReasonCode,
                  style=labelStyle, color=labelColor, textcolor=color.white, size=size.normal)
    
    if not na(tradeProfit)
        dollarGain = currentBalance * (tradeProfit / 100)
        currentBalance := currentBalance + dollarGain
        compoundTotalPercent := ((currentBalance - initialBalance) / initialBalance) * 100
        totalRealizedPnL += tradeProfit
        totalTrades += 1
        lastExitPnL := tradeProfit
        lastExitReason := exitReasonCode
    
    // Reset State
    isOrderActive := false
    orderEntryPrice := na
    orderEntryBar := na
    orderEntryTime := na
    trailingTop := na
    trailingActive := false
    earlyTrailingActive := false
    peakTrailingActive := false
    currentTrailingPercent := na
    entryPriceLine := na
    earlyTrailStartLine := na
    peakTrailStartLine := na
    stopLossLine := na
    trailingMinus := na
    requiredProfitLine := na

// ====================================================================
// SECTION 12: VISUALS (Standard)
// ====================================================================
plotshape(showSignals and buyEntry, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.large)
plotshape(showSignals and sellEntry, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.large)
plotshape(showSignals and orderExit, style=shape.xcross, location=location.abovebar, color=color.yellow, size=size.normal)

plot(showLines and isOrderActive and not na(entryPriceLine) ? entryPriceLine : na, color=color.orange, linewidth=2)
plot(showLines and isOrderActive and not na(earlyTrailStartLine) ? earlyTrailStartLine : na, color=color.purple, linewidth=1)
plot(showLines and isOrderActive and not na(peakTrailStartLine) ? peakTrailStartLine : na, color=color.fuchsia, linewidth=2)
plot(showLines and isOrderActive and not na(stopLossLine) ? stopLossLine : na, color=color.red, linewidth=1, style=plot.style_circles)
plot(showLines and isOrderActive and trailingActive and not na(trailingMinus) ? trailingMinus : na, 
     color=peakTrailingActive ? color.lime : earlyTrailingActive ? color.aqua : color.blue, linewidth=2)
plot(showLines and isOrderActive and not na(requiredProfitLine) ? requiredProfitLine : na, 
     color=color.yellow, linewidth=3, style=plot.style_line)

// ====================================================================
// SECTION 13: TABLE (Standard - Reduced Size)
// ====================================================================
if barstate.islast
    var table reportTable = table.new(position.top_left, 3, 6, bgcolor=color.white, border_width=2)
    
    // Header
    table.cell(reportTable, 0, 0, "COMPOUND %", text_color=color.white, bgcolor=color.black)
    table.cell(reportTable, 1, 0, str.tostring(compoundTotalPercent, "#.##") + "%", text_color=color.white, bgcolor=compoundTotalPercent>=0?color.green:color.red)
    
    // Balance
    table.cell(reportTable, 0, 1, "Balance", text_color=color.black)
    table.cell(reportTable, 1, 1, "$" + str.tostring(currentBalance, "#.##"), text_color=color.black)
    
    // Trades
    table.cell(reportTable, 0, 2, "Trades", text_color=color.black)
    table.cell(reportTable, 1, 2, str.tostring(totalTrades), text_color=color.black)
    
    // Hourly Decay Status
    table.cell(reportTable, 0, 3, "Req Profit", text_color=color.black)
    table.cell(reportTable, 1, 3, isOrderActive ? str.tostring(dynamicProfitRequired, "#.##")+"%" : "-", text_color=color.blue)

// ====================================================================
// SECTION 14: JSON EXPORT (ROBUST V7.2)
// ====================================================================
if showParamDisplay and barstate.islast
    var table jsonTable = table.new(position.middle_right, 1, 2, bgcolor=color.black, border_width=1)
    
    // Build JSON parts
    string json1 = '{"tradeMode": "' + (isBuyMode ? "BUY" : "SELL") + '", "rsiWindow": ' + str.tostring(rsiWindow) + 
                   ', "oversoldLevel_Int": ' + str.tostring(oversoldLevel_Int) + ', "oversoldLevel_Dec": ' + str.tostring(oversoldLevel_Dec) + 
                   ', "overboughtLevel_Int": ' + str.tostring(overboughtLevel_Int) + ', "overboughtLevel_Dec": ' + str.tostring(overboughtLevel_Dec) + 
                   ', "rsiExitLevelBuy_Int": ' + str.tostring(rsiExitLevelBuy_Int) + ', "rsiExitLevelBuy_Dec": ' + str.tostring(rsiExitLevelBuy_Dec) + 
                   ', "rsiExitLevelSell_Int": ' + str.tostring(rsiExitLevelSell_Int) + ', "rsiExitLevelSell_Dec": ' + str.tostring(rsiExitLevelSell_Dec)
                   
    string json2 = ', "fastLength": ' + str.tostring(fastLength) + ', "slowLength": ' + str.tostring(slowLength) + ', "signalLength": ' + str.tostring(signalLength) +
                   ', "volMALength": ' + str.tostring(isBuyMode ? volMALengthBuy : volMALengthSell) + 
                   ', "volThreshold": ' + str.tostring(isBuyMode ? volThresholdBuy : volThresholdSell) + 
                   ', "useVolumeFilter": ' + str.tostring(isBuyMode ? useVolumeFilterBuy : useVolumeFilterSell) + 
                   ', "atrLength": ' + str.tostring(isBuyMode ? atrLengthBuy : atrLengthSell) + 
                   ', "atrMALength": ' + str.tostring(isBuyMode ? atrMALengthBuy : atrMALengthSell) + 
                   ', "atrThreshold": ' + str.tostring(isBuyMode ? atrThresholdBuy : atrThresholdSell) + 
                   ', "useATRFilter": ' + str.tostring(isBuyMode ? useATRFilterBuy : useATRFilterSell)

    string json3 = ', "stopLossInt": ' + str.tostring(isBuyMode ? stopLossPercentBuy_Int : stopLossPercentSell_Int) + 
                   ', "stopLossDec": ' + str.tostring(isBuyMode ? stopLossPercentBuy_Dec : stopLossPercentSell_Dec) + 
                   ', "earlyStartInt": ' + str.tostring(isBuyMode ? earlyTrailStartBuy_Int : earlyTrailStartSell_Int) + 
                   ', "earlyStartDec": ' + str.tostring(isBuyMode ? earlyTrailStartBuy_Dec : earlyTrailStartSell_Dec) + 
                   ', "earlyMinusInt": ' + str.tostring(isBuyMode ? earlyTrailMinusBuy_Int : earlyTrailMinusSell_Int) + 
                   ', "earlyMinusDec": ' + str.tostring(isBuyMode ? earlyTrailMinusBuy_Dec : earlyTrailMinusSell_Dec) + 
                   ', "peakStartInt": ' + str.tostring(isBuyMode ? peakTrailStartBuy_Int : peakTrailStartSell_Int) + 
                   ', "peakStartDec": ' + str.tostring(isBuyMode ? peakTrailStartBuy_Dec : peakTrailStartSell_Dec) + 
                   ', "peakMinusInt": ' + str.tostring(isBuyMode ? peakTrailMinusBuy_Int : peakTrailMinusSell_Int) + 
                   ', "peakMinusDec": ' + str.tostring(isBuyMode ? peakTrailMinusBuy_Dec : peakTrailMinusSell_Dec)

    string json4 = ', "initialProfit": ' + str.tostring(isBuyMode ? initialProfitBuy : initialProfitSell) + 
                   ', "decayStart": ' + str.tostring(isBuyMode ? startLoweringAfterHoursBuy : startLoweringAfterHoursSell) + 
                   ', "decayRate": ' + str.tostring(isBuyMode ? lowerByPercentPerHourBuy : lowerByPercentPerHourSell) + 
                   ', "minProfitFloor": ' + str.tostring(isBuyMode ? minProfitFloorBuy : minProfitFloorSell) + 
                   ', "enableAlerts": ' + str.tostring(enableAlerts) + 
                   ', "showLines": ' + str.tostring(showLines) + 
                   ', "showSignals": ' + str.tostring(showSignals) + '}'

    table.cell(jsonTable, 0, 0, "ðŸ“‹ JSON EXPORT (V7.2)", text_color=color.yellow, text_size=size.small)
    table.cell(jsonTable, 0, 1, json1 + json2 + json3 + json4, text_color=color.white, text_size=size.tiny, text_halign=text.align_left)