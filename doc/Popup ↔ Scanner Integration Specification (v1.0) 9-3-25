Popup ‚Üî Scanner Integration Specification (v1.0) 9-3-25
Project: AIMn Multi-Professor Auto-Trading System
Scope: How the Scanner hands off an entry to the Popup Trading UI, how the Popup executes and exits, and how completion is reported back to the Scanner‚Äîusing consistent auth, payloads, and DB fields.

1) Components & Roles
    ‚Ä¢ Scanner System (meirniv.pythonanywhere.com): Finds entries, decides symbol / side / entry / qty (and optional risk params) and initiates an order session.
    ‚Ä¢ Popup Trading UI (popup-trader-ui-meirniv.pythonanywhere.com):
Renders a real-time chart (our own canvas, not TV), displays entry, trail-start, stop, top/minus trailing, and detects exits (T/L/R/P). Saves snapshots and writes orders to DB.
    ‚Ä¢ Database:
        ‚ó¶ Current prod in Popup: SQLite (trader.db) with tables trade_sessions, orders, tenants.
        ‚ó¶ Target for shared state: MySQL (MeirNiv$trading_db). We provide compatible schemas so we can migrate without breaking API contracts.

2) Message Flow (happy path)
Scanner
  ‚îî‚îÄ POST /api/trade_sessions  (create session, optional params)
        ‚Üì
Popup creates session (id = SID), returns popup URL
        ‚Üì
User sees popup chart, lines lock at entry; trailing active
        ‚Üì
Exit happens (T/L/R/P) ‚Üí Popup POST /api/trade-completed (to Scanner)
        ‚Üì
Scanner marks signal processed, resumes exchange scanning
Exit codes:
T = Trailing, L = Stop loss, R = RSI rule, P = Panic/manual

3) Authentication & Multi-User
    ‚Ä¢ Auth: Authorization: Bearer <SHARED_API_KEY> on both directions.
    ‚Ä¢ Tenant (optional): X-Tenant: <tenant> (defaults to "public" if omitted).
    ‚Ä¢ User: X-User-Id: <user_id> (or ?user=<id> for dev). Popup stores user_id on both trade_sessions and orders.
Note: Broker API keys/secret are not in URLs. They must be stored server-side (DB secrets table or environment variables) and only used by the trading adapter‚Äînever echoed to clients.

4) API Contracts
4.1 Scanner ‚Üí Popup: Create Session
POST https://popup-trader-ui-meirniv.pythonanywhere.com/api/trade_sessions
Headers
Authorization: Bearer <SHARED_API_KEY>
Content-Type: application/json
X-User-Id: default_user             # required for multi-user separation
X-Tenant: public                    # optional
Body (minimum)
{
  "signal_id": 12345,
  "symbol": "AAPL",
  "exchange": "NASDAQ",
  "side": "BUY",
  "qty": 10,
  "entry_price": 221.45
}
Optional strategy knobs (percent semantics; all optional):
"params": {
  "p21": 2.0,    // stop loss %
  "p23": 0.3,    // trail start %
  "p25": 1.5,    // early trailing width (minus %) 
  "p27": 1.5,    // tighten at PnL%
  "p29": 1.0,    // late trailing width (minus %)
  "p31": 0.5     // RSI min profit % (gate for R)
}
Success (200)
{
  "ok": true,
  "id": 1002,
  "sid": 1002,
  "user_id": "default_user",
  "popup_url": "/chart_lite?symbol=AAPL&exchange=NASDAQ&side=BUY&qty=10&sid=1002&entry=221.45"
}
Notes
    ‚Ä¢ Popup returns a URL that opens our real-time chart with the session pinned (no TradingView delay).
    ‚Ä¢ If entry_price is omitted, popup seeds it from the live last price at moment of promotion and freezes it.
Errors
{ "ok": false, "error": "missing field: symbol" }

4.2 Popup ‚Üí Scanner: Trade Completed
POST https://meirniv.pythonanywhere.com/api/trade-completed
Headers
Authorization: Bearer <SHARED_API_KEY>
Content-Type: application/json
X-User-Id: default_user
X-Tenant: public
Body
{
  "signal_id": 12345,
  "session_id": 1002,
  "exchange": "NASDAQ",
  "symbol": "AAPL",
  "side": "BUY",
  "exit_reason": "T",
  "exit_price": 224.10,
  "pnl_percentage": 1.20,
  "trade_duration_seconds": 1425,
  "timestamp": "2025-09-03T10:39:15Z"
}
Success (200)
{
  "status": "success",
  "message": "Exchange NASDAQ scanning resumed",
  "exchange_state": { "exchange":"NASDAQ", "is_scanning": true, "active_position_symbol": null }
}
Failure (4xx/5xx)
{ "status":"error", "message":"Missing required fields: signal_id" }

5) Strategy Semantics (display + exits)
The Scanner owns entries. The Popup handles exit-only logic and renders lines:
    ‚Ä¢ Fixed lines (do not move once order locked):
        ‚ó¶ Entry: the exact price the order entered (frozen).
        ‚ó¶ Trail-Start: entry * (1 + p23%) for BUY; entry * (1 - p23%) for SELL.
        ‚ó¶ Stop Loss: entry * (1 - p21%) for BUY; entry * (1 + p21%) for SELL.
    ‚Ä¢ Trailing (dynamic, only moves upward for BUY / downward for SELL):
        ‚ó¶ Top Trailing = the highest price seen since arming (BUY), or lowest (SELL).
Arming begins once price crosses Trail-Start band from entry.
        ‚ó¶ Minus Trailing = Top * (1 - p25%) for BUY; Top * (1 + p25%) for SELL.
If p27 (PnL tighten threshold) is reached, width switches to p29%.
        ‚ó¶ Exit T triggers when last price crosses Minus Trailing in the adverse direction.
        ‚ó¶ Exit L triggers when last price crosses Stop Loss band.
        ‚ó¶ Exit R (optional): RSI exit allowed only if PnL ‚â• p31% and RSI threshold hit.
Exit labels on chart: shows reason letter (T/L/R/P) and P&L%.

6) Database
6.1 Current Popup (SQLite)
Tables already exist and are being written by the UI:
    ‚Ä¢ trade_sessions (additions already applied: user_id, status timestamps)
        ‚ó¶ id (PK), tenant, user_id, symbol, exchange, side, qty,
        ‚ó¶ entry_price, params_json, status, opened_at, closed_at,
        ‚ó¶ exit_price, exit_value, pnl_pct, pnl_amount, reason,
        ‚ó¶ snapshot_path, created_at
    ‚Ä¢ orders
        ‚ó¶ id (PK), tenant, user_id, symbol, exchange, side, qty,
        ‚ó¶ entry_price, exit_price, exit_value, pnl_pct, pnl_amount,
        ‚ó¶ reason, snapshot_path, created_at, exit_time
Planned column: signal_id on trade_sessions (so we can report back which signal we fulfilled).
Add (idempotent):
ALTER TABLE trade_sessions ADD COLUMN signal_id INTEGER;
CREATE INDEX IF NOT EXISTS idx_trade_sessions_signal ON trade_sessions(signal_id);
6.2 Shared MySQL (Target)
If/when we move to shared MySQL, mirror the tables:
CREATE TABLE trade_sessions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant VARCHAR(64) DEFAULT 'public',
  user_id VARCHAR(64) NOT NULL,
  signal_id BIGINT NULL,
  symbol VARCHAR(32) NOT NULL,
  exchange VARCHAR(32) NOT NULL,
  side ENUM('BUY','SELL') NOT NULL,
  qty INT NOT NULL,
  entry_price DECIMAL(18,8) NULL,
  params_json JSON NULL,
  status VARCHAR(16) DEFAULT 'NEW',
  opened_at BIGINT NULL,
  closed_at BIGINT NULL,
  exit_price DECIMAL(18,8) NULL,
  exit_value DECIMAL(18,8) NULL,
  pnl_pct DECIMAL(9,4) NULL,
  pnl_amount DECIMAL(18,8) NULL,
  reason CHAR(1) NULL,
  snapshot_path VARCHAR(255) NULL,
  created_at BIGINT NOT NULL
);

CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant VARCHAR(64) DEFAULT 'public',
  user_id VARCHAR(64) NOT NULL,
  symbol VARCHAR(32) NOT NULL,
  exchange VARCHAR(32) NOT NULL,
  side ENUM('BUY','SELL') NOT NULL,
  qty INT NOT NULL,
  entry_price DECIMAL(18,8) NOT NULL,
  exit_price DECIMAL(18,8) NOT NULL,
  exit_value DECIMAL(18,8) NULL,
  pnl_pct DECIMAL(9,4) NULL,
  pnl_amount DECIMAL(18,8) NULL,
  reason CHAR(1) NOT NULL,
  snapshot_path VARCHAR(255) NULL,
  created_at BIGINT NOT NULL,
  exit_time BIGINT NOT NULL
);

CREATE INDEX idx_sessions_user ON trade_sessions(user_id);
CREATE INDEX idx_orders_user   ON orders(user_id);
CREATE INDEX idx_sessions_signal ON trade_sessions(signal_id);
If the Scanner team prefers to keep their own signal_alerts table, that‚Äôs fine‚Äîtrade_sessions.signal_id simply references it for correlation.

7) Required Endpoints (Popup)
Already implemented:
    ‚Ä¢ POST /api/trade_sessions ‚Äî Create session (supports params, entry_price, and headers for X-User-Id, X-Tenant).
    ‚Ä¢ POST /api/trade_sessions/<sid>/close ‚Äî Record exit (reason, exit price, PnL); writes orders and updates session.
    ‚Ä¢ POST /api/trade_sessions/<sid>/snapshot ‚Äî Accepts a data:image/png;base64, to save chart frame for history.
    ‚Ä¢ GET /chart_lite?... ‚Äî Real-time canvas chart (no TV), draws fixed lines + moving trailing, shows entry arrow when locked.
    ‚Ä¢ Health/Debug: /healthz, /healthz/db, /healthz/lite
Dev helpers (don‚Äôt use from Scanner in prod):
    ‚Ä¢ GET /api/trade_sessions/quick and /quick_safe (no-fail demo creators)

8) Error Handling & Idempotency
    ‚Ä¢ If Scanner retries POST /api/trade_sessions, provide an Idempotency-Key header (UUID). Popup will treat repeated keys within a short window as the same request (we can add a small idempotency table or reuse a unique key on (user_id, signal_id)).
    ‚Ä¢ On any 4xx from Popup, Scanner must not block the exchange permanently; roll back ‚Äúpaused scanning‚Äù state.
    ‚Ä¢ Popup retries the trade-completed POST on 5xx with exponential backoff (2 attempts is enough). If all fail, the exit is still recorded locally; Scanner can reconcile via a periodic fetch (future endpoint: /api/exits?since=...).

9) Security
    ‚Ä¢ Shared API key in Authorization: Bearer ‚Ä¶ both ways.
    ‚Ä¢ No secrets in URLs. Broker credentials are stored server-side and fetched per user_id + tenant when needed.
    ‚Ä¢ Input validation: both sides validate required fields and bounds on percents. Reject on missing symbol, bad side, nonsense qty, etc.
    ‚Ä¢ Auditing: log request IDs, user_id, tenant, signal_id, sid.

10) Acceptance Criteria
    ‚Ä¢ Create session
        ‚ó¶ Given a valid JSON payload with auth, Popup returns { ok:true, sid } and a popup_url.
        ‚ó¶ The chart opens with fixed Entry/Trail-Start/Stop lines and shows the entry arrow once locked.
    ‚Ä¢ Trailing behavior
        ‚ó¶ Top trailing ascends with new highs (BUY) and never drops; Minus trailing is computed with p25% (or p29% after p27% gain).
        ‚ó¶ Exit T fires exactly when price crosses Minus trailing.
    ‚Ä¢ Stop loss
        ‚ó¶ Exit L fires exactly when price crosses stop band from entry.
    ‚Ä¢ Completion callback
        ‚ó¶ On exit, Popup POSTs to Scanner /api/trade-completed with exit reason, price, PnL%.
    ‚Ä¢ Multi-user
        ‚ó¶ user_id propagates into trade_sessions and orders.
    ‚Ä¢ Health
        ‚ó¶ /healthz endpoints return ok.

11) Test Plan (quick)
    1. Create Session (Scanner)
        ‚ó¶ POST to Popup with signal_id, symbol, exchange, side, qty, entry_price, params.
        ‚ó¶ Expect { ok:true, sid, popup_url }.
    2. Visual
        ‚ó¶ Open popup_url. Entry/Trail-Start/Stop are fixed. Last price line moves. Entry arrow shown.
    3. Trailing Exit
        ‚ó¶ Use parameters that are easy to hit (e.g., p23=0.1, p25=0.5) and verify exit T POST reaches Scanner.
    4. Stop Exit
        ‚ó¶ Set p21 small so price crosses quickly; verify exit L.
    5. Panic
        ‚ó¶ Click ‚ÄúPanic Close‚Äù (or POST directly). Verify exit P.
    6. DB
        ‚ó¶ Check trade_sessions and orders rows with correct user_id, signal_id, PnL, exit reason.

12) Open Items / Alignment Needed
    ‚Ä¢ Shared DB: If the Scanner team really wants one MySQL for both sides, we‚Äôll:
        ‚ó¶ Migrate Popup to write MySQL instead of SQLite (or dual-write for a transition period).
        ‚ó¶ Add trade_sessions.signal_id now to align.
    ‚Ä¢ Strategy knobs: Confirm % semantics (all percent, not decimals) for p21/p23/p25/p29; p27/p31 are also percent, but not converted to decimals (PnL% thresholds).
    ‚Ä¢ Idempotency: Decide between (user_id, signal_id) uniqueness vs an Idempotency-Key header table.
    ‚Ä¢ Broker adapters: When live trading is on, the Popup will call a broker adapter; credentials will be looked up by (tenant, user_id, broker) in a secrets table.

13) Example cURL
Create session
curl -X POST https://popup-trader-ui-meirniv.pythonanywhere.com/api/trade_sessions \
  -H "Authorization: Bearer $SHARED_API_KEY" \
  -H "X-User-Id: default_user" \
  -H "Content-Type: application/json" \
  -d '{
    "signal_id": 12345,
    "symbol": "AAPL",
    "exchange": "NASDAQ",
    "side": "BUY",
    "qty": 10,
    "entry_price": 221.45,
    "params": { "p21":2, "p23":0.3, "p25":1.5, "p27":1.5, "p29":1.0, "p31":0.5 }
  }'
Trade completed (Popup ‚Üí Scanner)
curl -X POST https://meirniv.pythonanywhere.com/api/trade-completed \
  -H "Authorization: Bearer $SHARED_API_KEY" \
  -H "X-User-Id: default_user" \
  -H "Content-Type: application/json" \
  -d '{
    "signal_id": 12345,
    "session_id": 1002,
    "exchange": "NASDAQ",
    "symbol": "AAPL",
    "side": "BUY",
    "exit_reason": "T",
    "exit_price": 224.10,
    "pnl_percentage": 1.20,
    "trade_duration_seconds": 1425,
    "timestamp":"2025-09-03T10:39:15Z"
  }'

14) Deployment Checklist (Popup side)
    ‚Ä¢ SHARED_API_KEY set as env var on server.
    ‚Ä¢ resolve_user() + ensure_user_columns() applied (already done on your app).
    ‚Ä¢ trade_sessions.signal_id column added.
    ‚Ä¢ /api/trade_sessions accepts signal_id, params, entry_price; returns popup_url.
    ‚Ä¢ /api/trade_sessions/<sid>/close posts orders and calls Scanner /api/trade-completed.
    ‚Ä¢ Health endpoints return ok.
    ‚Ä¢ (Later) Swap SQLite ‚Üí MySQL connection strings when shared DB is greenlit.

If the Scanner team wants changes (field names, status codes, or moving the shared DB sooner), just mark them in this doc and we‚Äôll update both sides in lockstep. Once we agree here, you‚Äôll be a nudge away from live trading‚Äîand then we can go wild on the demos. üöÄ
