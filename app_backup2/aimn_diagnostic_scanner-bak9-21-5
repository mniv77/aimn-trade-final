<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIMn Scanner - Multi-Indicator Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes scanPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                transform: scale(1.02);
            }
        }

        .row-testing {
            animation: scanPulse 2s infinite;
            border: 2px solid #3b82f6 !important;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.25) 50%, rgba(59, 130, 246, 0.15) 100%);
        }

        .indicator-pass { color: #10b981; }
        .indicator-fail { color: #ef4444; }
        .indicator-neutral { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <div class="p-4 mb-4">
        <h1 class="text-3xl font-bold text-center mb-2">AIMn Multi-Indicator Scanner Diagnostics</h1>
        <p class="text-center text-gray-400">Real-time 4-Indicator Analysis: RSI + MACD + Volume + ATR</p>

        <!-- Enhanced Testing Status -->
        <div class="text-center mt-4">
            <div class="inline-flex flex-col items-center space-y-2 bg-gray-800 px-6 py-4 rounded-lg">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                    <span class="text-sm font-semibold">Currently Testing: <span id="current-testing-symbol" class="font-mono text-blue-400">--</span></span>
                </div>

                <!-- Multi-Indicator Status Display -->
                <div id="indicator-status" class="grid grid-cols-4 gap-4 text-xs">
                    <div class="text-center">
                        <div class="font-semibold">RSI</div>
                        <div id="rsi-status" class="indicator-neutral">--</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">MACD</div>
                        <div id="macd-status" class="indicator-neutral">--</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Volume</div>
                        <div id="volume-status" class="indicator-neutral">--</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">ATR</div>
                        <div id="atr-status" class="indicator-neutral">--</div>
                    </div>
                </div>

                <!-- Signal Decision Display -->
                <div class="mt-2 p-2 bg-gray-700 rounded">
                    <span class="text-xs font-semibold">Final Signal: </span>
                    <span id="final-signal" class="font-mono">ANALYZING...</span>
                    <span id="signal-reason" class="text-xs text-gray-400 ml-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostic Panel -->
    <div class="mx-4 mb-4 bg-gray-800 rounded-lg p-4">
        <h2 class="text-xl font-semibold mb-3">Signal Inhibitor Analysis</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Live Inhibitor Display -->
            <div class="bg-gray-700 rounded p-3">
                <h3 class="font-semibold text-red-400 mb-2">Current Inhibitors</h3>
                <div id="inhibitor-list" class="space-y-1 text-sm">
                    <div class="text-gray-400">Analyzing...</div>
                </div>
            </div>

            <!-- Signal Statistics -->
            <div class="bg-gray-700 rounded p-3">
                <h3 class="font-semibold text-green-400 mb-2">Signal Statistics</h3>
                <div id="signal-stats" class="space-y-1 text-sm">
                    <div>RSI Signals: <span id="rsi-count">0</span></div>
                    <div>MACD Signals: <span id="macd-count">0</span></div>
                    <div>Volume OK: <span id="volume-count">0</span></div>
                    <div>ATR OK: <span id="atr-count">0</span></div>
                    <div class="text-blue-400 font-semibold">All 4 Aligned: <span id="aligned-count">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Scan Results with Indicator Breakdown -->
    <div class="mx-4 bg-gray-800 rounded-lg p-4">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-semibold">Multi-Indicator Breakdown</h2>
            <div class="flex items-center space-x-2 text-sm">
                <div class="w-3 h-3 bg-blue-500 rounded animate-pulse"></div>
                <span class="text-gray-400">Row 4 = Testing Position</span>
            </div>
        </div>

        <div class="overflow-hidden">
            <!-- Enhanced Headers -->
            <div class="grid grid-cols-12 gap-1 text-xs font-semibold text-gray-400 mb-2 px-2">
                <div>Exchange</div>
                <div>Symbol</div>
                <div>Price</div>
                <div>RSI</div>
                <div>RSI ‚úì</div>
                <div>MACD</div>
                <div>MACD ‚úì</div>
                <div>Vol</div>
                <div>Vol ‚úì</div>
                <div>ATR</div>
                <div>ATR ‚úì</div>
                <div>Final Signal</div>
            </div>

            <div id="enhanced-scan-results" class="max-h-96 overflow-y-auto space-y-1">
                <!-- Enhanced scan results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Parameter Tuning Suggestions -->
    <div class="mx-4 mb-4 bg-gray-800 rounded-lg p-4">
        <h2 class="text-xl font-semibold mb-3">Tuning Suggestions</h2>
        <div id="tuning-suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <!-- Suggestions will be populated here -->
        </div>
    </div>

    <!-- Navigation -->
    <div class="m-4 text-center">
        <a href="/" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <script>
        let scanData = [];
        let signalStats = {
            rsi: 0, macd: 0, volume: 0, atr: 0, aligned: 0, total: 0
        };

        // Simulated tuning parameters (these would come from your tuning center)
        const tuningParams = {
            rsi: {
                oversold: 30,
                overbought: 70,
                enabled: true
            },
            macd: {
                enabled: true,
                sensitivity: 0.6 // Higher = more signals
            },
            volume: {
                enabled: true,
                threshold: 1.2 // 1.2x average volume required
            },
            atr: {
                enabled: true,
                minVolatility: 0.8 // Minimum volatility threshold
            }
        };

        // Enhanced multi-indicator signal detection
        function analyzeSymbol(symbol) {
            const rsi = parseFloat(symbol.rsi);
            const price = parseFloat(symbol.price);

            // RSI Analysis
            const rsiSignal = tuningParams.rsi.enabled ?
                (rsi <= tuningParams.rsi.oversold ? 'BUY' :
                 rsi >= tuningParams.rsi.overbought ? 'SELL' : 'NEUTRAL') : 'NEUTRAL';

            // MACD Analysis (simulated)
            const macdValue = (Math.random() - 0.5) * 2; // -1 to 1
            const macdSignal = tuningParams.macd.enabled ?
                (macdValue > tuningParams.macd.sensitivity ? 'BUY' :
                 macdValue < -tuningParams.macd.sensitivity ? 'SELL' : 'NEUTRAL') : 'NEUTRAL';

            // Volume Analysis (simulated)
            const volumeMultiplier = 0.5 + Math.random() * 2; // 0.5x to 2.5x average
            const volumeOK = tuningParams.volume.enabled ?
                volumeMultiplier >= tuningParams.volume.threshold : true;

            // ATR Analysis (simulated volatility)
            const atrValue = Math.random() * 2; // 0 to 2
            const atrOK = tuningParams.atr.enabled ?
                atrValue >= tuningParams.atr.minVolatility : true;

            // Final signal decision
            let finalSignal = 'NEUTRAL';
            let signalReason = '';

            if (rsiSignal !== 'NEUTRAL' && macdSignal !== 'NEUTRAL' &&
                rsiSignal === macdSignal && volumeOK && atrOK) {
                finalSignal = rsiSignal;
                signalReason = 'All indicators aligned';
                signalStats.aligned++;
            } else {
                const blockers = [];
                if (rsiSignal === 'NEUTRAL') blockers.push('RSI neutral');
                if (macdSignal === 'NEUTRAL') blockers.push('MACD neutral');
                if (rsiSignal !== 'NEUTRAL' && macdSignal !== 'NEUTRAL' && rsiSignal !== macdSignal) {
                    blockers.push('RSI/MACD conflict');
                }
                if (!volumeOK) blockers.push('Low volume');
                if (!atrOK) blockers.push('Low volatility');

                signalReason = blockers.length > 0 ? `Blocked: ${blockers.join(', ')}` : 'No signal';
            }

            // Update stats
            if (rsiSignal !== 'NEUTRAL') signalStats.rsi++;
            if (macdSignal !== 'NEUTRAL') signalStats.macd++;
            if (volumeOK) signalStats.volume++;
            if (atrOK) signalStats.atr++;
            signalStats.total++;

            return {
                rsi: { value: rsi, signal: rsiSignal },
                macd: { value: macdValue.toFixed(3), signal: macdSignal },
                volume: { value: volumeMultiplier.toFixed(2), ok: volumeOK },
                atr: { value: atrValue.toFixed(2), ok: atrOK },
                finalSignal,
                signalReason
            };
        }

        // Update testing indicators for row 4
        function updateTestingIndicators() {
            const row4Symbol = scanData[3];
            if (!row4Symbol) return;

            const analysis = analyzeSymbol(row4Symbol);

            // Update symbol name
            document.getElementById('current-testing-symbol').textContent =
                `${row4Symbol.exchange}:${row4Symbol.symbol}`;

            // Update individual indicator status
            const rsiStatus = document.getElementById('rsi-status');
            rsiStatus.textContent = `${analysis.rsi.value} (${analysis.rsi.signal})`;
            rsiStatus.className = analysis.rsi.signal !== 'NEUTRAL' ? 'indicator-pass' : 'indicator-neutral';

            const macdStatus = document.getElementById('macd-status');
            macdStatus.textContent = `${analysis.macd.value} (${analysis.macd.signal})`;
            macdStatus.className = analysis.macd.signal !== 'NEUTRAL' ? 'indicator-pass' : 'indicator-neutral';

            const volumeStatus = document.getElementById('volume-status');
            volumeStatus.textContent = `${analysis.volume.value}x (${analysis.volume.ok ? 'OK' : 'LOW'})`;
            volumeStatus.className = analysis.volume.ok ? 'indicator-pass' : 'indicator-fail';

            const atrStatus = document.getElementById('atr-status');
            atrStatus.textContent = `${analysis.atr.value} (${analysis.atr.ok ? 'OK' : 'LOW'})`;
            atrStatus.className = analysis.atr.ok ? 'indicator-pass' : 'indicator-fail';

            // Update final signal
            const finalSignal = document.getElementById('final-signal');
            finalSignal.textContent = analysis.finalSignal;
            finalSignal.className = analysis.finalSignal === 'BUY' ? 'text-green-400' :
                                   analysis.finalSignal === 'SELL' ? 'text-red-400' : 'text-gray-400';

            document.getElementById('signal-reason').textContent = analysis.signalReason;

            // Update inhibitor list
            updateInhibitorList(analysis);
        }

        function updateInhibitorList(analysis) {
            const inhibitorList = document.getElementById('inhibitor-list');
            const inhibitors = [];

            if (analysis.rsi.signal === 'NEUTRAL') {
                inhibitors.push(`RSI: ${analysis.rsi.value} (need ‚â§${tuningParams.rsi.oversold} or ‚â•${tuningParams.rsi.overbought})`);
            }
            if (analysis.macd.signal === 'NEUTRAL') {
                inhibitors.push(`MACD: ${analysis.macd.value} (need ‚â§-${tuningParams.macd.sensitivity} or ‚â•${tuningParams.macd.sensitivity})`);
            }
            if (!analysis.volume.ok) {
                inhibitors.push(`Volume: ${analysis.volume.value}x (need ‚â•${tuningParams.volume.threshold}x)`);
            }
            if (!analysis.atr.ok) {
                inhibitors.push(`ATR: ${analysis.atr.value} (need ‚â•${tuningParams.atr.minVolatility})`);
            }

            if (inhibitors.length === 0) {
                inhibitorList.innerHTML = '<div class="text-green-400">All indicators aligned!</div>';
            } else {
                inhibitorList.innerHTML = inhibitors.map(inhibitor =>
                    `<div class="text-red-400">‚Ä¢ ${inhibitor}</div>`
                ).join('');
            }
        }

        function updateSignalStats() {
            document.getElementById('rsi-count').textContent = signalStats.rsi;
            document.getElementById('macd-count').textContent = signalStats.macd;
            document.getElementById('volume-count').textContent = signalStats.volume;
            document.getElementById('atr-count').textContent = signalStats.atr;
            document.getElementById('aligned-count').textContent = signalStats.aligned;
        }

        function generateSampleData() {
            const symbols = [
                {symbol: 'BTC/USD', exchange: 'CRYPTO'},
                {symbol: 'ETH/USD', exchange: 'CRYPTO'},
                {symbol: 'AAPL', exchange: 'ALPACA'},
                {symbol: 'TSLA', exchange: 'ALPACA'},
                {symbol: 'NVDA', exchange: 'ALPACA'},
                {symbol: 'SPY', exchange: 'NYSE'},
                {symbol: 'QQQ', exchange: 'NYSE'},
                {symbol: 'MSFT', exchange: 'NYSE'},
                {symbol: 'AMZN', exchange: 'NYSE'},
                {symbol: 'GOOGL', exchange: 'ALPACA'},
                {symbol: 'META', exchange: 'NYSE'},
                {symbol: 'NFLX', exchange: 'ALPACA'}
            ];

            scanData = symbols.map(({symbol, exchange}) => ({
                symbol,
                exchange,
                price: (Math.random() * 500 + 50).toFixed(2),
                rsi: (Math.random() * 100).toFixed(1),
                isAvailable: exchange !== 'CRYPTO',
                isActivelyTrading: exchange === 'CRYPTO' && symbol === 'BTC/USD'
            }));
        }

        function updateEnhancedScanResults() {
            const container = document.getElementById('enhanced-scan-results');
            container.innerHTML = '';

            // Reset stats
            signalStats = { rsi: 0, macd: 0, volume: 0, atr: 0, aligned: 0, total: 0 };

            scanData.slice(0, 12).forEach((symbol, index) => {
                const analysis = analyzeSymbol(symbol);
                const isTestingRow = index === 3;

                const div = document.createElement('div');
                div.className = `grid grid-cols-12 gap-1 p-2 rounded transition-all duration-300 ${
                    isTestingRow ? 'row-testing bg-blue-900' : 'bg-gray-700'
                }`;

                div.innerHTML = `
                    <div class="text-xs ${isTestingRow ? 'text-blue-300 font-bold' : 'text-gray-300'}">${symbol.exchange}</div>
                    <div class="text-xs font-mono ${isTestingRow ? 'font-bold text-white' : ''}">${symbol.symbol}</div>
                    <div class="text-xs font-mono">$${symbol.price}</div>
                    <div class="text-xs font-mono">${analysis.rsi.value}</div>
                    <div class="text-xs text-center ${analysis.rsi.signal !== 'NEUTRAL' ? 'text-green-400' : 'text-gray-500'}">
                        ${analysis.rsi.signal !== 'NEUTRAL' ? '‚úì' : '‚úó'}
                    </div>
                    <div class="text-xs font-mono">${analysis.macd.value}</div>
                    <div class="text-xs text-center ${analysis.macd.signal !== 'NEUTRAL' ? 'text-green-400' : 'text-gray-500'}">
                        ${analysis.macd.signal !== 'NEUTRAL' ? '‚úì' : '‚úó'}
                    </div>
                    <div class="text-xs font-mono">${analysis.volume.value}x</div>
                    <div class="text-xs text-center ${analysis.volume.ok ? 'text-green-400' : 'text-red-400'}">
                        ${analysis.volume.ok ? '‚úì' : '‚úó'}
                    </div>
                    <div class="text-xs font-mono">${analysis.atr.value}</div>
                    <div class="text-xs text-center ${analysis.atr.ok ? 'text-green-400' : 'text-red-400'}">
                        ${analysis.atr.ok ? '‚úì' : '‚úó'}
                    </div>
                    <div class="text-xs font-bold ${
                        analysis.finalSignal === 'BUY' ? 'text-green-400' :
                        analysis.finalSignal === 'SELL' ? 'text-red-400' : 'text-gray-400'
                    }">
                        ${analysis.finalSignal}
                        ${isTestingRow && analysis.finalSignal !== 'NEUTRAL' ? ' üö®' : ''}
                    </div>
                `;

                container.appendChild(div);
            });

            updateSignalStats();
        }

        function generateTuningSuggestions() {
            const container = document.getElementById('tuning-suggestions');
            const suggestions = [];

            if (signalStats.rsi < signalStats.total * 0.1) {
                suggestions.push(`<div class="bg-yellow-900 p-3 rounded">
                    <div class="font-semibold text-yellow-400">RSI Too Restrictive</div>
                    <div class="text-sm">Only ${signalStats.rsi}/${signalStats.total} symbols have RSI signals. Consider widening thresholds.</div>
                </div>`);
            }

            if (signalStats.volume < signalStats.total * 0.3) {
                suggestions.push(`<div class="bg-red-900 p-3 rounded">
                    <div class="font-semibold text-red-400">Volume Filter Too Strict</div>
                    <div class="text-sm">Only ${signalStats.volume}/${signalStats.total} symbols pass volume filter. Lower threshold from ${tuningParams.volume.threshold}x.</div>
                </div>`);
            }

            if (signalStats.aligned === 0) {
                suggestions.push(`<div class="bg-red-900 p-3 rounded">
                    <div class="font-semibold text-red-400">No Aligned Signals</div>
                    <div class="text-sm">All 4 indicators never align. Consider disabling optional filters or loosening thresholds.</div>
                </div>`);
            }

            if (suggestions.length === 0) {
                suggestions.push(`<div class="bg-green-900 p-3 rounded">
                    <div class="font-semibold text-green-400">Parameters Look Good</div>
                    <div class="text-sm">Signal generation is balanced. ${signalStats.aligned} aligned signals detected.</div>
                </div>`);
            }

            container.innerHTML = suggestions.join('');
        }

        // Initialize
        generateSampleData();
        updateEnhancedScanResults();
        generateTuningSuggestions();

        // Update testing row every 3 seconds
        setInterval(() => {
            updateTestingIndicators();
        }, 1000);

        // Refresh data every 5 seconds
        setInterval(() => {
            generateSampleData();
            updateEnhancedScanResults();
            generateTuningSuggestions();
        }, 5000);

        // Conveyor belt effect
        setInterval(() => {
            if (scanData.length > 1) {
                const firstItem = scanData.shift();
                scanData.push(firstItem);
                updateEnhancedScanResults();
            }
        }, 2500);
    </script>
</body>
</html>